#include <iostream>
#include <fstream>
#include <algorithm>
#include <bits/stdc++.h>
using namespace std;
//搭建学生成绩表  一个学生：姓名+成绩
//定义学生结构体，包含姓名和成绩
struct Student {
	string name;	//对应表格中姓名
	int score;	//对应表格的成绩 
}; 
//函数功能：显示所有学生姓名和成绩
//参数：students[] = 学生数组、count = 学生信息数量
void displayStudents(Student students[], int count){
	//循环遍历每个学生（从第1个到第count个）
	for(int i = 1; i <= count; i++) {
		//输出第i个同学的姓名和成绩
		cout << "姓名：" << students[i].name << "，成绩：" << students[i].score << endl; 
	} 
}

//函数功能：增加学生
//参数： students[] = 学生数组、count = 学生信息数量
void addStudents(Student students[], int &count){
	//临时学生变量（存用户输入的信息） 
	Student s;	
	cout << "请输入学生姓名：" << endl;
	cin >> s.name;
	cout << "请输入学生成绩：" << endl;
	cin >> s.score; 
	count++;
	students[count] = s;
} 

// 功能：根据姓名修改学生成绩
// 参数：students[]=学生数组，count=学生数量，targetName=要修改的学生姓名
void modifyStudent(Student students[], int count, string targetName) {
    bool found = false;  // 标记是否找到目标学生（默认没找到）
    for (int i = 1; i <= count; i++) {
        if (students[i].name == targetName) {  // 匹配姓名
            cout << "找到学生：" << targetName << "，当前成绩：" << students[i].score << endl;
            cout << "请输入新成绩：";
            cin >> students[i].score;  // 覆盖旧成绩
            found = true;  // 标记为找到
            break;  // 找到后不用继续遍历，退出循环
        }
    }
    if (!found) {  // 如果没找到
        cout << "未找到姓名为 " << targetName << " 的学生！" << endl;
    }
}

// 功能：根据姓名删除学生
// 参数：students[]=学生数组，&count=学生数量（引用，需减少），targetName=要删除的学生姓名
void deleteStudent(Student students[], int &count, string targetName) {
    bool found = false;
    for (int i = 1; i <= count; i++) {
        if (students[i].name == targetName) {  // 找到要删除的位置 i
            // 内层循环：从 i+1 开始，后面的元素往前移 1 位
            for (int j = i; j < count; j++) {
                students[j] = students[j + 1];  // 第 j+1 个元素覆盖第 j 个
            }
            count--;  // 学生总数减 1（相当于“划掉最后一行”）
            found = true;
            cout << "成功删除学生：" << targetName << endl;
            break;
        }
    }
    if (!found) {
        cout << "未找到姓名为 " << targetName << " 的学生！" << endl;
    }
}

// 功能：将学生信息保存到 students.txt 文件
void findStudent(Student students[], int &count) {
	int e;
	cout<<"请输入查询选择: 1,通过成绩查询 2,通过分数范围查询 3,通过姓名查询"<<"\n";
	cin>>e;
	if(e==1){
    	int d;
    	cout<<"请输入查询的分数:"<<"\n";
    	cin>>d;
   		bool flag = false;
		for(int i=1;i<=count;i++){
			if(students[i].score==d)
				flag = true;
		} 
		if(flag=false){
			cout<<"未有分数为"<<d<<"的学生!"<<"\n";
			return; 
		}
		cout<<"分数为"<<d<<"的学生:"<<"\n";
    	for(int i=1;i<=count;i++){
    		if(students[i].score==d){
    			cout<<"姓名:"<<students[i].name<<"\n";
			}
		}
	} 
	if(e==2){
		cout<<"请输入查询的范围:"<<"\n";
		int a,b;
		cin>>a>>b;
 		bool flag = false;
		for(int i=1;i<=count;i++){
			if(students[i].score>=a&&students[i].score<=b||students[i].score<=a&&students[i].score>=b)
				flag = true;
		} 
		if(flag=false){
			cout<<"未有分数范围为"<<a<<"到"<<b<<"的学生!"<<"\n"; 
			return;
		}
		if(a>b)
			cout<<"范围在"<<b<<"到"<<a<<"之间的学生"<<"\n"; 
		if(a<b)
			cout<<"范围在"<<a<<"到"<<b<<"之间的学生"<<"\n"; 
		if(a==b)
			cout<<"分数为"<<a<<"的学生"<<"\n"; 
		for(int i=1;i<=count;i++){
			if(students[i].score>=a&&students[i].score<=b||students[i].score<=a&&students[i].score>=b)
				cout<<"姓名:"<<students[i].name<<" 成绩:"<<students[i].score<<"\n";
		}
	}
	if(e==3){
		string a;
		cout<<"请输入学生姓名或相关汉字:"<<"\n";
		cin>>a;
		bool flag = false;
		for(int i=1;i<=count;i++){
			if(students[i].name.find(a)!=string::npos)
				flag = true;
		}
		if(flag==false){
			cout<<"未有相关学生请再次确认!"<<"\n";
	}
		for(int i=1;i<=count;i++){
			if(students[i].name.find(a)!=string::npos)
				cout<<"姓名:"<<students[i].name<<" 成绩:"<<students[i].score<<"\n";
		}
	}
}
bool cmp(Student a,Student b){
			if(a.score>b.score)
				return true;
			else
				return false;
		}
bool sum(Student a,Student b){
			if(a.score<b.score)
				return true;
			else
				return false;
		}
bool temp(Student a,Student b){
			if(a.name>b.name)
				return true;
			else
				return false;
		}
bool nam(Student a,Student b){
			if(a.name<b.name)
				return true;
			else
				return false;
		}
void orderStudents(Student students[],int &count) {
	int a; 
	cout<<"请输入排序方式: 1,成绩高到低 2,成绩低到高 3,姓名高到低 4,姓名低到高"<<"\n";
	cin>>a;
	if(a==1){
		sort(students+1,students+1+count,cmp);
		for(int i=1;i<=count;i++){
			cout<<"姓名:"<<students[i].name<<" 成绩:"<<students[i].score<<"\n";
		}
	}
	if(a==2){
		sort(students+1,students+1+count,sum);
		for(int i=1;i<=count;i++){
			cout<<"姓名:"<<students[i].name<<" 成绩:"<<students[i].score<<"\n";
		}
	}
	if(a==3){
		sort(students+1,students+1+count,temp);
		for(int i=1;i<=count;i++){
			cout<<"姓名:"<<students[i].name<<" 成绩:"<<students[i].score<<"\n";
		}
	}
	if(a==4){
		sort(students+1,students+1+count,nam);
		for(int i=1;i<=count;i++){
			cout<<"姓名:"<<students[i].name<<" 成绩:"<<students[i].score<<"\n";
		}
	}
}
// 功能：将学生信息保存到 students.txt 文件
void saveStudents(Student students[], int count) {
    ofstream file("students.txt");  // 创建输出文件流（写文件）
    if (!file.is_open()) {  // 判断文件是否成功打开
        cout << "文件打开失败，保存失败！" << endl;
        return;
    }
    // 遍历数组，将每个学生信息写入文件（格式：姓名 成绩）
    for (int i = 1; i <= count; i++) {
        file << students[i].name << " " << students[i].score << endl;
    }
    file.close();  // 关闭文件（必须写，否则数据可能没保存）
    cout << "学生信息已成功保存到 students.txt！" << endl;
}

// 功能：从 students.txt 文件加载学生信息到数组
void loadStudents(Student students[], int &count) {
    ifstream file("students.txt");  // 创建输入文件流（读文件）
    if (!file.is_open()) {
        cout << "未找到历史文件，将创建新名单！" << endl;
        return;
    }
    Student s;
    // 关键：用 file >> s.name >> s.score 作为循环条件，避免读取文件末尾空行
    while (file >> s.name >> s.score) {
    	count++;
        students[count] = s;  // 加载到数组，总数加 1
    }
    file.close();
    cout << "成功加载 " << count << " 条学生信息！" << endl;
}


//功能：清空所有学生信息（需确定）
void clearAllStudents(int &count) {
	if(count == 0) {
		cout << "当前无学生信息，无需清空！" << endl;
		return ;
	}
	char confirm;
	cout << "确定要清空所有学生信息？（y/n）：";
	cin >> confirm;
	if(confirm == 'y' || confirm == 'Y') {
		count = 0;	//直接重置计数（数组数据无需手动清空，后续会被覆盖）
		cout << "已清空所有学生信息！" << endl; 
	} else {
		cout << "已取消清空操作！" << endl;
	}
} 

//函数功能：统计学生成绩的平均分、最高分、最低分
void statsStudents(Student students[], int count){
	if(count == 0) {
		cout << "暂无学生信息，无法统计！" << endl;
		return ;
	}
	int sum = 0, maxS = students[1].score, minS = students[1].score;
	for(int i = 1; i <= count; i++) {
		sum += students[i].score;
		if (students[i].score > maxS) 
			maxS = students[i].score;
        if (students[i].score < minS) 
			minS = students[i].score;
	}
	double avg = (double)sum / count; // 平均分（保留1位小数）
    cout << "\n成绩统计：" << endl;
    cout << "平均分：" << fixed << setprecision(1) << avg << endl;
    cout << "最高分：" << maxS << endl;
    cout << "最低分：" << minS << endl;
} 

//函数功能：批量添加学生（一次输入多个）
void batchStudents(Student students[], int &count) {
	int num;
	cout << "请输入要批量添加的学生数量：";
	cin >> num;
	if(num <= 0 || count + num > 100) {
		cout << "输入无效或超出最大容量（100人）！" << endl;
		return ;
	}
	for(int i = 1; i <= num; i++) {
		Student s;
		cout << "请输入第" << i << "个学生姓名及成绩：";
		cin >> s.name;
		cin >> s.score;
		if(s.score < 0 || s.score > 100) {
			cout << "成绩必须在0~100之间，该学生添加失败！" << endl;
			continue;
		} 
		count++;
		students[count] = s;
	}
	cout << "批量添加完成！当前共" << count << "名学生。" << endl;
} 

//函数功能：登录
bool loginStudents() {
	string password;
	cout << "请输入管理员密码：";
	cin >> password;
	if(password == "admin") {
		cout << "登录成功！" << endl;
		return true; 
	}
	else {
		cout << "密码错误，无法操作！" << endl;
		return false; 
	}
} 


int main() {
	//定义能存100个学生的数组（类比表格里有100行）
	Student students[100];
	//记录当前有多少个学生（初识有0人）
	int count = 0; 
	
	if(loginStudents()==true) {
		loadStudents(students, count); // 启动时加载历史数据
		
		int choice; //用户选择（1=添加，2=显示，0=退出）
		
		do{
			cout << "===== 学生信息管理系统======\n";
			cout << "1. 添加学生" << endl;
			cout << "2. 查看学生" <<endl;
			cout << "3. 修改学生" << endl; 
			cout << "4. 删除学生" << endl; 
			cout << "5. 保存文件" << endl; 
			cout << "6. 查询特定学生" << endl; 
			cout << "7. 清空" << endl;
			cout << "8. 成绩统计" << endl;
			cout << "9. 批量添加学生" << endl;
			cout << "10.学生排序" << endl;
			cout << "0. 退出" << endl;
			cout << "请选择操作（输入数字）：" << endl;
			cin >> choice;
			
			switch(choice) {
				case 1:
					addStudents(students,count);
					cout << "添加成功！" << endl;
					break;
				case 2:
					cout << "\n当前学生信息" << endl;
					displayStudents(students, count);
					break;
				case 3: {
				    string name;
				    cout << "请输入要修改成绩的学生姓名：";
				    cin >> name;
				    modifyStudent(students, count, name);
				    break;
				}
				case 4: {
				    string name;
				    cout << "请输入要删除的学生姓名：";
				    cin >> name;
				    deleteStudent(students, count, name);
				    break;
				}
				case 5:
				    saveStudents(students, count);
				    break;
				case 6:
					findStudent(students,count);
					break;
				case 7:
					clearAllStudents(count);
					break;
				case 8:
					statsStudents(students, count);
					break;
				case 9:
					batchStudents(students, count);
					break;
				case 10:
					orderStudents(students, count);
					break;
				case 0:
					cout << "退出程序！" << endl;
					break;
				default:
					cout << "输入错误，请重新选择！" << endl;
			} 
		} while(choice!=0);
	}
    return 0;
}
